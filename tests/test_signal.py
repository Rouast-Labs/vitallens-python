# FILE: tests/test_signal.py
# Copyright (c) 2024 Philipp Rouast
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

import numpy as np
import pytest

import sys
sys.path.append('../vitallens-python')

from vitallens.enums import Method
from vitallens.signal import reassemble_from_windows, assemble_results, estimate_rolling_vitals

@pytest.mark.parametrize(
  "name, x_batches, idxs_batches, expected_x, expected_idxs",
  [
    # Test case 1: Standard overlap
    (
      "standard_overlap",
      [
        np.array([[2.0, 4.0, 6.0, 8.0, 10.0], [2.0, 3.0, 4.0, 5.0, 6.0]]),
        np.array([[7.0, 1.0, 10.0, 12.0, 18.0], [7.0, 8.0, 9.0, 10.0, 11.0]])
      ],
      [
        np.array([1, 3, 5, 7, 9]),
        np.array([5, 6, 9, 11, 13])
      ],
      np.array([[2.0, 4.0, 6.0, 8.0, 10.0, 12.0, 18.0],
                [2.0, 3.0, 4.0, 5.0, 6.0, 10.0, 11.0]]),
      np.array([1, 3, 5, 7, 9, 11, 13])
    ),
    # Test case 2: No overlap between windows.
    (
      "no_overlap",
      [
        np.array([[1, 2], [10, 20]]),
        np.array([[3, 4], [30, 40]])
      ],
      [
        np.array([0, 1]),
        np.array([3, 4])
      ],
      np.array([[1, 2, 3, 4], [10, 20, 30, 40]]),
      np.array([0, 1, 3, 4])
    ),
    # Test case 3: A single window.
    (
      "single_window",
      [
        np.array([[1, 2, 3], [10, 20, 30]])
      ],
      [
        np.array([0, 1, 2])
      ],
      np.array([[1, 2, 3], [10, 20, 30]]),
      np.array([0, 1, 2])
    )
  ]
)
def test_reassemble_from_windows_edge_cases(name, x_batches, idxs_batches, expected_x, expected_idxs):
  out_x, out_idxs = reassemble_from_windows(x=x_batches, idxs=idxs_batches)
  np.testing.assert_allclose(out_x, expected_x, err_msg=f"Failed on case: {name} (data)")
  np.testing.assert_equal(out_idxs, expected_idxs, err_msg=f"Failed on case: {name} (indices)")

@pytest.mark.parametrize("signals", [('ppg_waveform',), ('respiratory_waveform',), ('ppg_waveform','respiratory_waveform')])
@pytest.mark.parametrize("can_provide_confidence", [True, False])
@pytest.mark.parametrize("min_t_too_long", [True, False])
@pytest.mark.parametrize("method_arg", [Method.G, "g", "vitallens-2.0"])
def test_assemble_results(signals, can_provide_confidence, min_t_too_long, method_arg):
  sample_video_hr = 60.5
  sample_video_rr = 12.
  sig_ppg = [-0.4083,-0.4870,-0.5349,-0.5744,-0.5844,-0.2449,0.1615,0.3899,0.2642,0.4055,0.8509,1.2770,1.2852,1.1860,1.0460,0.8798,0.6355,0.3384,0.1496,-0.0557,-0.2071,-0.3669,-0.5196,-0.6868,-0.8333,-0.9207,-0.9780,-1.0261,-1.0442,-0.9659,-0.9299,-0.9369,-0.9989,-0.9606,-0.9246,-0.9377,-0.9436,-0.4722,0.3687,1.2693,1.7929,1.9902,1.9927,1.7719,1.4279,1.0693,0.7988,0.5610,0.3588,0.1722,0.0160,-0.1632,-0.3328,-0.5028,-0.6100,-0.7312,-0.8427,-0.9521,-1.0169,-1.0677,-1.0762,-1.0810,-1.0155,-1.0183,-0.9524,-0.5942,0.1621,1.0288,1.6288,1.8838,1.8947,1.6794,1.3318,0.9841,0.7191,0.5162,0.3285,0.1507,-0.0154,-0.1985,-0.3625,-0.5233,-0.6556,-0.7937,-0.9154,-1.0269,-1.1071,-1.1602,-1.1696,-1.1418,-1.0680,-1.0450,-1.0053,-0.7943,-0.1595,0.5459,1.2173,1.5796,1.8557,1.8893,1.7867,1.5623,1.3052,0.9894,0.6957,0.4454,0.2840,0.1159,-0.0753,-0.2834,-0.4472,-0.5744,-0.6988,-0.8263,-0.9340,-1.0200,-1.0884,-1.1461,-1.1877,-1.2084,-1.2175,-1.1728,-1.0763,-1.0812,-0.9748,-0.5586,0.2922,1.0402,1.5650,1.7920,1.9558,1.9332,1.7531,1.5007,1.2016,0.9378,0.6770,0.4527,0.2762,0.1168,-0.0452,-0.2213,-0.3531,-0.4610,-0.5556,-0.6738,-0.7797,-0.8611,-0.9315,-1.0020,-1.0779,-1.1226,-1.1486,-1.1595,-1.1606,-1.1465,-1.0825,-0.7966,-0.1147,0.7163,1.4678,1.8762,2.0371,1.9188,1.6311,1.3107,1.0236,0.7714,0.5440,0.3526,0.1949,0.0479,-0.0887,-0.2237,-0.3338,-0.4495,-0.5715,-0.7017,-0.8126,-0.9056,-0.9881,-1.0832,-1.1496,-1.1891,-1.1639,-1.0625,-0.9432,-0.8945,-0.7143,-0.1024,0.7737,1.5254,1.8308,1.8765,1.7334,1.4570,1.1337,0.8512,0.6467,0.4641,0.2975,0.1319,-0.0166,-0.1772,-0.3255,-0.4689,-0.5952,-0.7292,-0.8450,-0.9470,-1.0155,-1.0691,-1.0933,-1.0868,-0.9516,-0.9493,-0.7276,-0.1801,0.6854,1.3954,1.6719,1.7254,1.5889,1.3148,0.9823,0.7029,0.4945,0.3113,0.1323,-0.0327,-0.1748,-0.3303,-0.4868,-0.6315,-0.7396,-0.8467,-0.9409,-1.0106,-1.0768,-1.1120,-1.1232,-1.0409,-0.9668,-0.9050,-0.5287,0.2341,1.0636,1.6463,1.8035,1.7923,1.5829,1.3407,1.0977,0.8118,0.5318,0.2946,0.1286,-0.0579,-0.2498,-0.4388,-0.5757,-0.7087,-0.8260,-0.9523,-1.0450,-1.1196,-1.1497,-1.1653,-1.1699,-1.1829,-1.0498,-0.5364,0.2799,1.1249,1.6516,1.8845,1.8873,1.7041,1.4127,1.0875,0.7965,0.5300,0.2986,0.1053,-0.0560,-0.2257,-0.3977,-0.5707,-0.7084,-0.8404,-0.9615,-1.0957,-1.1583,-1.1935,-1.1824,-1.1457,-1.1101,-1.0692,-0.9919,-0.7167,-0.1740,0.5670,1.2549,1.7388,1.9519,1.9377,1.7372,1.4552,1.1682,0.8869,0.5943,0.3481,0.1584,0.0013,-0.1499,-0.2991,-0.4343,-0.5679,-0.6806,-0.7918,-0.8780,-0.9716,-1.0572,-1.1466,-1.1819,-1.1744,-1.1190,-1.0441,-0.9120,-0.8688,-0.4748,0.2072,1.1213,1.7113,1.9401,1.9397,1.7687,1.4714,1.1611,0.8781,0.6450,0.4126,0.2196,0.0540,-0.0807,-0.2300,-0.3880,-0.5466,-0.6817,-0.8037,-0.9018,-0.9984,-1.0749,-1.1407,-1.1673,-1.1641,-1.1091,-1.0658,-0.8800,-0.6699,-0.2174,-0.0367,0.4601,0.8853,1.5025,1.7526,1.8027,1.7299,1.5605,1.2811,0.9786,0.7044,0.5232,0.3470,0.1675,-0.0036,-0.1306,-0.2650,-0.3877,-0.5090,-0.6084,-0.7226,-0.8290,-0.9122,-0.9587,-0.9864,-1.0103,-1.0283,-0.9953,-0.9831,-0.9334,-0.9280,-0.8389,-0.8085,-0.5427,0.0905,0.9084,1.5709,1.8341,1.9146,1.7963,1.5712,1.2910,1.0356,0.8188,0.6085,0.4131,0.2185,0.0654,-0.0746,-0.2145,-0.3641,-0.4905,-0.6023,-0.7098,-0.7949,-0.8602,-0.8976,-0.9368,-0.9790,-1.0263,-1.0601,-1.0585,-0.9929,-0.9197,-0.8934,-0.5820,-0.0033,0.8495,1.3758,1.6934,1.7771,1.7700,1.5628,1.2534,0.9562,0.7120,0.4919,0.2770,0.1065,-0.0485,-0.2027,-0.3606,-0.5129,-0.6067,-0.6866,-0.7421,-0.8288,-0.9179,-0.9830,-1.0401,-1.0513,-1.0079,-0.9813,-0.9353,-0.8247,-0.4010,-0.1069,0.4898,0.9894,1.6220,1.7962,1.7257,1.5288,1.3169,1.0462,0.7720,0.5112,0.3459,0.1939,0.0050,-0.2020,-0.3345,-0.4689,-0.5922,-0.7290,-0.8134,-0.8942,-0.9755,-1.0423,-1.0725,-1.1050,-1.0997,-1.0037,-0.7404,-0.6626,-0.4402,0.1287,0.9602,1.6379,1.7996,1.7824,1.5706,1.2648,0.9476,0.6820,0.4924,0.3139,0.1485,-0.0451,-0.2120,-0.3790,-0.5063,-0.6320,-0.7392,-0.8419,-0.9265,-0.9984,-1.0418,-1.0621,-1.0510,-1.0458,-0.9745,-0.6929,-0.1304,0.5416,1.1707,1.5759,1.8158,1.7314,1.4575,1.1060,0.8223,0.5809,0.3580,0.1750,0.0179,-0.1880,-0.3995,-0.5799,-0.6943,-0.8105,-0.9105,-1.0006,-1.0555,-1.0929,-1.0890,-1.0717,-1.0691,-1.0835,-1.0090,-0.5589,0.1409,0.7784,1.2456,1.5164,1.7678,1.8317,1.7655,1.6013,1.3243,0.9859,0.6393,0.3173,0.0752,-0.1309,-0.2915,-0.4423,-0.5697,-0.6980,-0.8111,-0.9306,-1.0014,-1.0585,-1.0806,-1.1191,-1.1529,-1.1912,-1.2005,-1.0287,-0.8734,-0.6632,-0.1333,0.6502,1.4507,1.8187,1.9089,1.8552,1.6615,1.3969,1.0882,0.7952,0.5774,0.3760,0.1681,-0.0522,-0.2297,-0.3979,-0.5552,-0.7063,-0.8194,-0.9158,-0.9969,-1.0783,-1.1462,-1.2057,-1.2415,-1.2600,-1.2322,-1.2379,-1.1944,-1.0021,-0.4662,0.1166,0.8041,1.3121,1.7669,1.9082,1.8469,1.6798,1.4911,1.2721,1.0299,0.7710,0.5731,0.4015,0.2350,0.0763,-0.0481,-0.1557,-0.2654,-0.3696,-0.4470,-0.4934,-0.5307,-0.5684,-0.5941,-0.6083,-0.5997,-0.5896]
  sig_resp = [-0.4324,-0.4442,-0.4730,-0.5232,-0.5757,-0.6074,-0.6844,-0.7499,-0.7832,-0.8396,-0.8881,-0.9281,-0.9436,-0.9487,-0.9491,-0.9269,-0.9221,-0.9240,-0.9347,-0.9437,-0.9585,-0.9540,-0.9338,-0.9078,-0.8627,-0.8189,-0.7855,-0.7440,-0.7117,-0.6426,-0.5554,-0.4623,-0.3637,-0.2596,-0.1547,-0.0324,0.0944,0.2257,0.3440,0.4705,0.6045,0.7422,0.8750,1.0062,1.1484,1.2928,1.4215,1.5167,1.5979,1.6471,1.6939,1.7510,1.8110,1.8573,1.8936,1.9008,1.9097,1.9078,1.9006,1.8969,1.9110,1.9067,1.9157,1.9061,1.8858,1.8603,1.8291,1.7905,1.7706,1.7287,1.6765,1.6192,1.5532,1.4840,1.4081,1.3216,1.2261,1.1254,1.0129,0.9080,0.7978,0.6857,0.5737,0.4790,0.3823,0.2906,0.1970,0.1181,0.0383,-0.0394,-0.1151,-0.1816,-0.2455,-0.2982,-0.3536,-0.4018,-0.4663,-0.5228,-0.5761,-0.6221,-0.6669,-0.6920,-0.7127,-0.7386,-0.7638,-0.7934,-0.8393,-0.8664,-0.8951,-0.9204,-0.9440,-0.9696,-0.9861,-1.0070,-1.0347,-1.0560,-1.0746,-1.0844,-1.1015,-1.0939,-1.1073,-1.1189,-1.1326,-1.1467,-1.1533,-1.1623,-1.1715,-1.1809,-1.1908,-1.1942,-1.2037,-1.2043,-1.2101,-1.2070,-1.1965,-1.1833,-1.1704,-1.1642,-1.1589,-1.1561,-1.1513,-1.1412,-1.1347,-1.1252,-1.1139,-1.1010,-1.0913,-1.0819,-1.0680,-1.0562,-1.0411,-1.0304,-1.0120,-0.9971,-0.9912,-0.9839,-0.9804,-0.9773,-0.9752,-0.9684,-0.9603,-0.9545,-0.9491,-0.9377,-0.9265,-0.9218,-0.9166,-0.9055,-0.8931,-0.8822,-0.8694,-0.8535,-0.8382,-0.8242,-0.8076,-0.7919,-0.7743,-0.7459,-0.7080,-0.6586,-0.6052,-0.5505,-0.4848,-0.4215,-0.3650,-0.2922,-0.2100,-0.1125,-0.0058,0.1081,0.2148,0.3224,0.4412,0.5610,0.6832,0.8138,0.9512,1.0997,1.2302,1.3378,1.4186,1.5184,1.6057,1.6866,1.7678,1.8244,1.8790,1.9368,1.9751,2.0002,2.0167,2.0295,2.0488,2.0849,2.0859,2.0811,2.0841,2.0746,2.0665,2.0609,2.0420,2.0159,1.9937,1.9644,1.9397,1.9156,1.8799,1.8457,1.8103,1.7617,1.7115,1.6584,1.5931,1.5253,1.4613,1.3873,1.3171,1.2425,1.1544,1.0590,0.9636,0.8712,0.7767,0.6814,0.5764,0.4750,0.3885,0.3049,0.2085,0.1181,0.0326,-0.0465,-0.1085,-0.1795,-0.2547,-0.3140,-0.3735,-0.4235,-0.4584,-0.5092,-0.5709,-0.6075,-0.6466,-0.6928,-0.7457,-0.7992,-0.8393,-0.8734,-0.9147,-0.9457,-0.9727,-1.0151,-1.0535,-1.0728,-1.0942,-1.1186,-1.1384,-1.1405,-1.1404,-1.1360,-1.1368,-1.1337,-1.1298,-1.1241,-1.1200,-1.1043,-1.0916,-1.0852,-1.0707,-1.0577,-1.0443,-1.0293,-1.0272,-1.0183,-1.0117,-1.0043,-0.9976,-0.9870,-0.9833,-0.9759,-0.9643,-0.9624,-0.9561,-0.9534,-0.9613,-0.9557,-0.9561,-0.9541,-0.9521,-0.9456,-0.9377,-0.9280,-0.9239,-0.9188,-0.9110,-0.8997,-0.8774,-0.8478,-0.8161,-0.7824,-0.7494,-0.7210,-0.6965,-0.6715,-0.6421,-0.6246,-0.6005,-0.5708,-0.5459,-0.5227,-0.5015,-0.4871,-0.4636,-0.4325,-0.4133,-0.3928,-0.3751,-0.3681,-0.3518,-0.3344,-0.3214,-0.3038,-0.2856,-0.2579,-0.2166,-0.1874,-0.1588,-0.1067,-0.0367,0.0487,0.1506,0.2599,0.3652,0.4692,0.5817,0.6779,0.7226,0.7310,0.7650,0.8024,0.8559,0.9108,0.9558,1.0005,1.0394,1.0869,1.1470,1.2036,1.2719,1.3737,1.4867,1.5720,1.6496,1.6978,1.7176,1.7153,1.7012,1.6804,1.6463,1.6054,1.5412,1.4662,1.3951,1.3317,1.2737,1.2064,1.1354,1.0632,1.0007,0.9330,0.8620,0.7905,0.7077,0.6304,0.5644,0.4979,0.4172,0.3288,0.2425,0.1608,0.0793,-0.0018,-0.0814,-0.1521,-0.2260,-0.3034,-0.3680,-0.4493,-0.5257,-0.5760,-0.6128,-0.6412,-0.6783,-0.7052,-0.7345,-0.7585,-0.7879,-0.8096,-0.8138,-0.8272,-0.8324,-0.8417,-0.8547,-0.8643,-0.8809,-0.8880,-0.9008,-0.9105,-0.9224,-0.9311,-0.9307,-0.9414,-0.9524,-0.9543,-0.9593,-0.9597,-0.9615,-0.9631,-0.9528,-0.9398,-0.9298,-0.9131,-0.8907,-0.8762,-0.8626,-0.8450,-0.8260,-0.8044,-0.7859,-0.7786,-0.7676,-0.7738,-0.7786,-0.7674,-0.7566,-0.7501,-0.7418,-0.7263,-0.7146,-0.7056,-0.6904,-0.6724,-0.6512,-0.6283,-0.5931,-0.5534,-0.5171,-0.4914,-0.4563,-0.4155,-0.3779,-0.3248,-0.2643,-0.1956,-0.1338,-0.0715,0.0031,0.0715,0.1554,0.2518,0.3645,0.4471,0.5403,0.6558,0.7771,0.8941,1.0039,1.1138,1.2320,1.3445,1.4598,1.5576,1.6224,1.6718,1.7437,1.8025,1.8454,1.8709,1.8890,1.9007,1.9109,1.9123,1.9020,1.8805,1.8468,1.8263,1.8030,1.7746,1.7301,1.6743,1.6189,1.5589,1.4977,1.4392,1.3745,1.3065,1.2448,1.1911,1.1365,1.0858,1.0443,1.0021,0.9629,0.9137,0.8608,0.8075,0.7466,0.6832,0.6214,0.5552,0.4891,0.4234,0.3538,0.2734,0.2010,0.1345,0.0692,0.0093,-0.0520,-0.1129,-0.1637,-0.2060,-0.2496,-0.2922,-0.3331,-0.3685,-0.3916,-0.4148,-0.4489,-0.4686,-0.4783,-0.4870,-0.4890,-0.4876,-0.4888,-0.4839,-0.4793,-0.4687,-0.4597,-0.4563,-0.4561,-0.4462,-0.4493,-0.4491,-0.4449,-0.4439,-0.4555,-0.4746,-0.4861,-0.4966,-0.5116,-0.5201,-0.5310,-0.5374,-0.5412,-0.5408,-0.5554,-0.5644,-0.5713,-0.5683,-0.5611,-0.5641,-0.5617,-0.5542,-0.5501,-0.5416,-0.5289,-0.5235,-0.5142,-0.4928,-0.4791,-0.4654,-0.4430,-0.4232,-0.3989,-0.3727,-0.3625,-0.3501,-0.3473,-0.3508,-0.3454,-0.3384,-0.3338,-0.3229,-0.3140,-0.3142,-0.3018,-0.2893,-0.2950,-0.2807,-0.2658,-0.2481,-0.2267,-0.2118,-0.1976,-0.1737,-0.1605,-0.1410,-0.1267,-0.1216,-0.1157,-0.1018,-0.0941,-0.0848,-0.0718,-0.0644,-0.0583,-0.0512,-0.0590,-0.0598]
  if min_t_too_long:
    target_len = 100
    sig_ppg = sig_ppg[:target_len]
    sig_resp = sig_resp[:target_len]
  else:
    target_len = len(sig_ppg)
  sig, train_signals, pred_signals = [], [], []
  for s in ('ppg_waveform','respiratory_waveform'):
    if s in signals:
      sig.append(sig_ppg if s == 'ppg_waveform' else sig_resp)
      train_signals.append('ppg_waveform' if s == 'ppg_waveform' else 'respiratory_waveform')
      pred_signals.append('ppg_waveform' if s == 'ppg_waveform' else 'respiratory_waveform')
      pred_signals.append('heart_rate' if s == 'ppg_waveform' else 'respiratory_rate')
  sig = np.asarray(sig)
  conf = np.ones_like(sig)
  if can_provide_confidence:
    live = np.asarray([0.0044,0.6019,0.0187,0.2596,0.8126,0.917,0.9268,0.8473,0.6633,0.7306,0.7722,0.7069,0.4417,0.4826,0.6779,0.8098,0.4191,0.6346,0.7833,0.5752,0.715,0.8923,0.8444,0.9169,0.85,0.9615,0.9797,0.9907,0.9819,0.9908,0.9856,0.974,0.979,0.9916,0.9928,0.997,0.9906,0.9916,0.9975,0.9989,0.9968,0.9989,0.9996,0.9999,0.9995,0.9994,0.9988,0.9993,0.9974,0.9987,0.9995,0.998,0.9942,0.9984,0.9972,0.9993,0.9986,0.9987,0.9992,0.9991,0.9967,0.9988,0.9991,0.9983,0.997,0.9978,0.999,0.9986,0.9941,0.9997,0.9998,0.9997,0.9995,0.9989,0.9995,0.9981,0.9987,0.9985,0.998,0.9985,0.9938,0.9989,0.9982,0.9987,0.996,0.9965,0.998,0.9979,0.9954,0.9965,0.9919,0.9912,0.9902,0.9949,0.9954,0.9971,0.9942,0.9968,0.9996,0.9997,0.998,0.9994,0.9966,0.9934,0.9835,0.9863,0.9899,0.9938,0.993,0.9907,0.9937,0.9933,0.9809,0.9896,0.9917,0.9961,0.9913,0.9961,0.9972,0.997,0.9927,0.9938,0.9851,0.9785,0.9816,0.9868,0.9946,0.9949,0.9951,0.9973,0.9988,0.9991,0.9969,0.9975,0.9923,0.9918,0.9489,0.9819,0.9672,0.9722,0.9354,0.9632,0.9769,0.982,0.947,0.9703,0.9911,0.994,0.9864,0.9886,0.9892,0.9801,0.9805,0.9799,0.9735,0.9897,0.9816,0.9734,0.9765,0.9928,0.9753,0.9893,0.9968,0.9993,0.9974,0.998,0.9934,0.9716,0.9208,0.9156,0.9118,0.9587,0.9399,0.9594,0.985,0.9688,0.9514,0.9673,0.9799,0.9766,0.9799,0.9917,0.9873,0.9925,0.9875,0.9909,0.9939,0.9958,0.9921,0.9952,0.9988,0.9986,0.9995,0.9999,0.9998,0.9998,0.9983,0.9989,0.9984,0.9987,0.9831,0.9991,0.9989,0.9989,0.9957,0.9988,0.9988,0.9994,0.9976,0.9984,0.9991,0.9979,0.9976,0.9991,0.9993,0.9982,0.9975,0.9987,0.999,0.9988,0.9982,0.9997,0.9998,0.9997,0.9937,0.9981,0.9985,0.9966,0.9984,0.9964,0.9962,0.9976,0.9952,0.9981,0.9974,0.9987,0.9955,0.9975,0.9969,0.9942,0.9921,0.9925,0.9908,0.9955,0.9935,0.9974,0.9961,0.9982,0.9963,0.9988,0.9984,0.999,0.9967,0.9969,0.9925,0.9983,0.9958,0.996,0.9877,0.9924,0.996,0.9985,0.9805,0.9906,0.9978,0.9989,0.9907,0.9943,0.9955,0.9904,0.9796,0.9932,0.9936,0.9942,0.9977,0.9994,0.9997,0.9996,0.998,0.9961,0.9931,0.993,0.9741,0.9842,0.9874,0.9908,0.993,0.9963,0.994,0.9757,0.9825,0.9953,0.9929,0.9964,0.9901,0.9895,0.985,0.9602,0.9788,0.976,0.9867,0.9893,0.9634,0.996,0.9983,0.9994,0.997,0.9969,0.9843,0.9885,0.9561,0.9733,0.9894,0.9841,0.9685,0.9813,0.9654,0.9602,0.9312,0.9795,0.9803,0.9911,0.963,0.985,0.9835,0.9832,0.9664,0.98,0.971,0.9576,0.9514,0.9916,0.9889,0.9875,0.9966,0.9969,0.9994,0.9983,0.9821,0.971,0.9825,0.9859,0.9729,0.9824,0.9866,0.9894,0.979,0.9961,0.998,0.9969,0.9864,0.9965,0.999,0.9989,0.9966,0.9983,0.9939,0.9933,0.9912,0.9893,0.9873,0.9905,0.9783,0.9956,0.994,0.9973,0.9989,0.9993,0.9988,0.9968,0.9914,0.9823,0.9798,0.9924,0.9727,0.9976,0.9938,0.9951,0.9959,0.9982,0.9975,0.9975,0.9962,0.9965,0.9981,0.9985,0.9974,0.9982,0.9951,0.9878,0.9834,0.9906,0.992,0.9915,0.9903,0.9938,0.997,0.9983,0.9829,0.9987,0.9993,0.999,0.9877,0.9958,0.9813,0.9781,0.9662,0.9879,0.9895,0.9888,0.9533,0.9747,0.9791,0.9726,0.9817,0.989,0.9951,0.9908,0.9836,0.9914,0.9928,0.9952,0.9566,0.9848,0.9908,0.9748,0.9769,0.9924,0.9913,0.9836,0.9941,0.9971,0.9992,0.9994,0.992,0.988,0.9466,0.9786,0.9292,0.9763,0.9878,0.9888,0.9551,0.9852,0.9514,0.9689,0.9072,0.9636,0.9827,0.9254,0.5153,0.927,0.8591,0.8552,0.7245,0.864,0.8398,0.9472,0.9488,0.9813,0.9679,0.9933,0.9655,0.9905,0.9891,0.9762,0.9358,0.9778,0.9239,0.9572,0.8879,0.9795,0.9783,0.9898,0.8942,0.9667,0.9849,0.9866,0.9873,0.9833,0.9965,0.9968,0.9941,0.9964,0.9946,0.9866,0.9843,0.9951,0.9947,0.9906,0.9987,0.9993,0.9988,0.9989,0.972,0.9862,0.9909,0.9969,0.9858,0.9905,0.9946,0.9919,0.9912,0.996,0.9954,0.9982,0.9978,0.9975,0.9985,0.9988,0.9983,0.9977,0.9935,0.9942,0.9968,0.9984,0.9736,0.9983,0.9994,0.9994,0.9992,0.9985,0.999,0.9984,0.9954,0.998,0.9987,0.9988,0.9909,0.9983,0.9968,0.9974,0.9973,0.9983,0.9976,0.9961,0.9946,0.9957,0.9969,0.9965,0.9942,0.9944,0.995,0.9966,0.9983,0.9985,0.9987,0.9996,0.9996,0.9989,0.998,0.9969,0.9788,0.9939,0.9957,0.9964,0.9938,0.9981,0.9976,0.9974,0.9818,0.9947,0.9972,0.9988,0.99,0.9968,0.9959,0.9955,0.9876,0.9895,0.9921,0.9884,0.9879,0.9877,0.9978,0.9981,0.9979,0.9991,0.9987,0.9982,0.9786,0.988,0.9688,0.985,0.947,0.9824,0.9853,0.98,0.933,0.9825,0.9815,0.9875,0.9719,0.9896,0.9916,0.9955,0.9787,0.9852,0.9799,0.9653,0.9122,0.9627,0.9731,0.9746,0.9802,0.9858,0.988,0.9987,0.9979,0.9975,0.9926,0.9842,0.8907,0.9364,0.9357,0.9767,0.8572,0.9597,0.9523,0.9594,0.9192,0.9429,0.9818,0.9881,0.9765,0.9808,0.977,0.9845,0.9615,0.9823])
    live = live[:target_len]
  else:
    live = np.ones((sig.shape[1],))
  fps = 30.
  sig_dict = {}
  conf_dict = {}
  sig_iter = [sig] if sig.ndim == 1 else sig
  conf_iter = [conf] if conf.ndim == 1 else conf
  keys = [k for k in ('ppg_waveform', 'respiratory_waveform') if k in signals]
  sig_dict = dict(zip(keys, sig_iter))
  conf_dict = dict(zip(keys, conf_iter))
  method_str = method_arg.value if isinstance(method_arg, Method) else str(method_arg)
  out_data, out_conf, out_live, out_note, out_live = assemble_results(
    sig=sig_dict,
    conf=conf_dict,
    live=live,
    fps=fps,
    pred_signals=pred_signals,
    method_name=method_str,
    can_provide_confidence=can_provide_confidence
  )
  if 'ppg_waveform' in signals:
    np.testing.assert_allclose(out_data['ppg_waveform'], sig_ppg)
    assert method_str in out_note['ppg_waveform']
    if min_t_too_long:
      assert np.isnan(out_data.get('heart_rate', np.nan))
    else:
      np.testing.assert_allclose(out_data['heart_rate'], sample_video_hr, atol=0.5)
  if 'respiratory_waveform' in signals:
    np.testing.assert_allclose(out_data['respiratory_waveform'], sig_resp)
    assert method_str in out_note['respiratory_waveform']
    if min_t_too_long:
      assert np.isnan(out_data.get('respiratory_rate', np.nan))
    else:
      np.testing.assert_allclose(out_data['respiratory_rate'], sample_video_rr, atol=1.)

def test_estimate_rolling_vitals():
  """Test rolling vitals estimation with signal filtering and duration checks."""
  fps = 30.
  n_frames = int(60 * fps)
  data = {
    'ppg_waveform': np.random.rand(n_frames),
    'respiratory_waveform': np.random.rand(n_frames)
  }
  conf = {
    'ppg_waveform': np.random.rand(n_frames),
    'respiratory_waveform': np.random.rand(n_frames)
  }
  # Test 1: Selective signal processing
  signals_available = {'heart_rate'}
  vital_signs = {}
  estimate_rolling_vitals(
    vital_signs_dict=vital_signs,
    data=data,
    conf=conf,
    signals_available=signals_available,
    fps=fps,
    video_duration_s=60.
  )
  assert 'rolling_heart_rate' in vital_signs
  assert 'rolling_respiratory_rate' not in vital_signs
  # Test 2: Duration constraints
  short_n = int(5 * fps)
  short_data = {k: v[:short_n] for k,v in data.items()}
  short_conf = {k: v[:short_n] for k,v in conf.items()}
  vital_signs_short = {}
  estimate_rolling_vitals(
    vital_signs_dict=vital_signs_short,
    data=short_data,
    conf=short_conf,
    signals_available={'heart_rate', 'hrv_sdnn'},
    fps=fps,
    video_duration_s=5.0
  )
  assert 'rolling_heart_rate' not in vital_signs_short
  assert 'rolling_hrv_sdnn' not in vital_signs_short